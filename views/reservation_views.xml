<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Action pour ouvrir les réservations -->
    <record id="action_reservation" model="ir.actions.act_window">
        <field name="name">Réservations</field>
        <field name="res_model">travel.reservation</field>
        <field name="view_mode">tree,form</field>
    </record>
    
    <record id="view_reservation_tree" model="ir.ui.view">
        <field name="name">reservation.tree</field>
        <field name="model">travel.reservation</field>
        <field name="arch" type="xml">
            <tree decoration-success="status == 'confirmed'" decoration-info="status == 'done'" decoration-muted="status == 'cancel'">
                <field name="name"/>
                <field name="member_id"/>
                <field name="destination_id"/>
                <field name="trip_type"/>
                <field name="check_in"/>
                <field name="check_out"/>
                <field name="nights"/>
                <field name="total_price" widget="monetary" sum="Total"/>
                <field name="credit_used" widget="monetary"/>
                <field name="remaining_to_pay" widget="monetary" decoration-danger="remaining_to_pay > 0"/>
                <field name="workflow_progress_percent" widget="progressbar"/>
                <field name="status" widget="badge" decoration-success="status == 'confirmed'" decoration-info="status == 'done'" decoration-muted="status == 'cancel'"/>
            </tree>
        </field>
    </record>
    
    <record id="view_reservation_form" model="ir.ui.view">
        <field name="name">reservation.form</field>
        <field name="model">travel.reservation</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <field name="status" widget="statusbar" statusbar_visible="draft,confirmed,done,cancel"/>

                    <button name="action_create_invoice" type="object" string="Facturer" 
                            class="oe_highlight" icon="fa-file-pdf-o"
                            attrs="{'invisible': [('status', '=', 'draft')]}"/>
                    <button name="action_open_pos" type="object" string="Payer Caisse" 
                            class="oe_highlight" icon="fa-money"
                            attrs="{'invisible': [('remaining_to_pay', '&lt;=', 0)]}"/>
                    <button name="action_cancel_and_credit" type="object" string="Annuler &amp; Créditer" 
                            class="btn-danger" icon="fa-times"
                            attrs="{'invisible': [('status', 'in', ['done', 'cancel'])]}" 
                            confirm="Êtes-vous sûr de vouloir annuler cette réservation et créditer le client ?"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">

                        <button class="oe_stat_button" type="object" name="action_view_invoices" 
                                icon="fa-file-pdf-o" attrs="{'invisible': [('invoice_count', '=', 0)]}">
                            <field name="invoice_count" widget="statinfo" string="Factures"/>
                        </button>
                        <button class="oe_stat_button" type="object" name="action_view_cash_operations" 
                                icon="fa-money" attrs="{'invisible': [('cash_operation_count', '=', 0)]}">
                            <field name="cash_operation_count" widget="statinfo" string="Opérations Caisse"/>
                        </button>
                        <button class="oe_stat_button" type="object" name="action_view_pos_orders" 
                                icon="fa-shopping-cart" attrs="{'invisible': [('pos_order_count', '=', 0)]}">
                            <field name="pos_order_count" widget="statinfo" string="Commandes POS"/>
                        </button>
                    </div>
                    <div class="oe_title"><h1><field name="name" readonly="1"/></h1></div>
                    <div class="alert alert-info" role="alert" attrs="{'invisible': [('workflow_progress_percent', '=', 100)]}">
                        <strong>Progression du Workflow:</strong> <field name="workflow_progress_percent" widget="progressbar"/>
                    </div>
                    <group>
                        <group string="Client"><field name="member_id"/></group>
                        <group string="Voyage">
                            <field name="destination_id"/>
                            <field name="trip_type"/>
                        </group>
                    </group>
                    <group>
                        <group string="Période"><field name="check_in"/><field name="nights" readonly="1"/><field name="check_out"/></group>
                        <group string="Participants"><field name="adults"/><field name="children"/><field name="infants"/><field name="participants" readonly="1"/></group>
                    </group>
                    <group>
                        <group string="Hébergement"><field name="hotel_service_id"/><field name="supplier_id"/><field name="local_or_foreign"/></group>
                        <group string="Chambre"><field name="room_category"/><field name="room_type"/></group>
                    </group>
                    <group string="Tarifs">
                        <group>
                            <field name="currency_id" invisible="1"/>
                            <field name="price" widget="monetary" options="{'currency_field': 'currency_id'}" 
                                   help="Prix total du voyage pour toutes les nuits (rempli automatiquement depuis le voyage)"/>
                            <field name="purchase_amount" widget="monetary" options="{'currency_field': 'currency_id'}" 
                                   help="Prix d'achat en TND (peut être rempli manuellement ou calculé automatiquement depuis les services du fournisseur)"/>
                            <button name="action_compute_purchase_amount" string="Calculer depuis Fournisseur" type="object" 
                                    class="btn-secondary" icon="fa-calculator"
                                    attrs="{'invisible': [('supplier_id', '=', False)]}"
                                    help="Calculer automatiquement le prix d'achat depuis les services du fournisseur sélectionné"/>
                        </group>
                        <group>
                            <label for="total_price" string="Total TTC" style="font-weight: bold; font-size: 14px;"/>
                            <field name="total_price" readonly="1" widget="monetary" options="{'currency_field': 'currency_id'}" 
                                   style="font-weight: bold; font-size: 16px; color: #007cba;"/>
                            <field name="use_credit"/>
                            <field name="credit_used" readonly="1" widget="monetary" options="{'currency_field': 'currency_id'}"/>
                            <field name="remaining_to_pay" readonly="1" class="text-success" widget="monetary" options="{'currency_field': 'currency_id'}" 
                                   style="font-weight: bold;"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Services" name="services">
                            <field name="service_ids" widget="many2many_tags" nolabel="1"/>
                        </page>
                        <page string="Workflow" name="workflow">
                            <group>
                                <group string="Étapes du Workflow">
                                    <field name="has_invoice" widget="boolean_toggle" readonly="1"/>
                                    <label for="has_invoice" string="Facturé"/>
                                    <field name="has_payment" widget="boolean_toggle" readonly="1"/>
                                    <label for="has_payment" string="Paiement reçu"/>
                                </group>
                                <group string="Progression">
                                    <field name="workflow_progress_percent" widget="progressbar" readonly="1"/>
                                    <field name="workflow_progress" readonly="1" invisible="1"/>
                                </group>
                            </group>
                        </page>
                        <page string="Documents" name="documents">
                            <group>

                                <group string="Factures">
                                    <field name="invoice_ids" readonly="1" nolabel="1">
                                        <tree>
                                            <field name="name"/>
                                            <field name="date"/>
                                            <field name="amount_total" widget="monetary"/>
                                            <field name="state" widget="badge"/>
                                        </tree>
                                    </field>
                                </group>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>
</odoo>