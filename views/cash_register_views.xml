<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Actions -->
    <record id="action_cash_register_operation" model="ir.actions.act_window">
        <field name="name">Op√©rations de Caisse</field>
        <field name="res_model">cash.register.operation</field>
        <field name="view_mode">tree,kanban,form</field>
        <field name="context">{}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Cr√©er une nouvelle op√©ration
            </p>
            <p>
                Enregistrez les recettes et d√©penses de la caisse avec les r√©f√©rences appropri√©es.
            </p>
        </field>
    </record>

    <record id="action_cash_register" model="ir.actions.act_window">
        <field name="name">Caisses</field>
        <field name="res_model">cash.register</field>
        <field name="view_mode">tree,kanban,form</field>
        <field name="context">{'search_default_opened': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Cr√©er une nouvelle caisse
            </p>
            <p>
                Les caisses permettent de g√©rer les recettes et d√©penses de l'agence.
            </p>
        </field>
    </record>

    <!-- Vue Liste des Caisses -->
    <record id="view_cash_register_tree" model="ir.ui.view">
        <field name="name">cash.register.tree</field>
        <field name="model">cash.register</field>
        <field name="arch" type="xml">
            <tree string="Caisses" 
                  decoration-info="is_main == True" 
                  decoration-muted="state == 'closed'"
                  decoration-success="state == 'opened'">
                <field name="name" string="üè¶ Caisse"/>
                <field name="code" string="üîñ Code"/>
                <field name="is_main" invisible="1"/>
                <field name="main_cash_id" string="Caisse Principale" optional="show"/>
                <field name="sub_cash_count" string="üìä Sous-Caisses" attrs="{'invisible': [('is_main', '=', False)]}"/>
                <field name="user_id" string="üë§ Responsable"/>
                <field name="state" string="√âtat" widget="badge"/>
                <field name="opening_balance" string="üíµ Ouverture" widget="monetary"/>
                <field name="total_receipts" string="üì• Recettes" sum="Total Recettes" widget="monetary" decoration-success="True"/>
                <field name="total_expenses" string="üì§ D√©penses" sum="Total D√©penses" widget="monetary" decoration-danger="True"/>
                <field name="balance" string="üí∞ Solde" sum="Solde Total" widget="monetary" 
                       decoration-success="balance > 0" decoration-danger="balance &lt; 0" decoration-bf="True"/>
            </tree>
        </field>
    </record>

    <!-- Vue Kanban des Caisses -->
    <record id="view_cash_register_kanban" model="ir.ui.view">
        <field name="name">cash.register.kanban</field>
        <field name="model">cash.register</field>
        <field name="arch" type="xml">
            <kanban>
                <field name="name"/>
                <field name="code"/>
                <field name="is_main"/>
                <field name="state"/>
                <field name="balance"/>
                <field name="total_receipts"/>
                <field name="total_expenses"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click o_kanban_record_has_image_fill">
                            <div class="oe_kanban_details p-3">
                                <strong class="o_kanban_record_title fs-5 text-primary">
                                    <t t-if="record.is_main.raw_value">üè¶</t>
                                    <t t-else="">üí∞</t>
                                    <field name="name"/>
                                </strong>
                                <div class="mt-2">
                                    <span t-attf-class="badge fs-6 #{record.state.raw_value == 'opened' ? 'bg-success' : 'bg-secondary'}">
                                        <field name="state"/>
                                    </span>
                                </div>
                                <div class="mt-2">
                                    <span class="badge bg-success">
                                        üì• <field name="total_receipts" widget="monetary"/>
                                    </span>
                                </div>
                                <div class="mt-1">
                                    <span class="badge bg-danger">
                                        üì§ <field name="total_expenses" widget="monetary"/>
                                    </span>
                                </div>
                                <div class="mt-2">
                                    <span class="badge bg-primary fs-6">
                                        üíµ Solde: <field name="balance" widget="monetary"/>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Vue Formulaire des Caisses -->
    <record id="view_cash_register_form" model="ir.ui.view">
        <field name="name">cash.register.form</field>
        <field name="model">cash.register</field>
        <field name="arch" type="xml">
            <form string="Caisse">
                <header>
                    <button name="action_open_cash" string="üîì Ouvrir la Caisse" type="object" 
                            class="btn-success" attrs="{'invisible': [('state', '=', 'opened')]}"/>
                    <button name="action_close_cash" string="üîí Fermer la Caisse" type="object" 
                            class="btn-danger" attrs="{'invisible': [('state', '=', 'closed'), ('is_main', '=', False)]}"/>
                    <button name="action_close_sub_cash" string="üîí Fermer la Sous-Caisse" type="object" 
                            class="btn-danger" attrs="{'invisible': [('state', '=', 'closed'), ('is_main', '=', True)]}"/>
                    <field name="state" widget="statusbar" statusbar_visible="opened,closed"/>
                </header>
                <sheet>
                    <!-- Boutons statistiques -->
                    <div class="oe_button_box" name="button_box">
                        <button class="oe_stat_button" type="action" name="%(travel_pro_version1.action_cash_register_operation)d" 
                                icon="fa-arrow-down" context="{'default_cash_register_id': active_id, 'default_type': 'receipt', 'search_default_cash_register_id': active_id}">
                            <field name="total_receipts" widget="statinfo" string="Recettes"/>
                        </button>
                        <button class="oe_stat_button" type="action" name="%(travel_pro_version1.action_cash_register_operation)d" 
                                icon="fa-arrow-up" context="{'default_cash_register_id': active_id, 'default_type': 'expense', 'search_default_cash_register_id': active_id}">
                            <field name="total_expenses" widget="statinfo" string="D√©penses"/>
                        </button>
                        <button class="oe_stat_button" type="action" name="%(travel_pro_version1.action_cash_register)d" 
                                icon="fa-sitemap" attrs="{'invisible': [('is_main', '=', False)]}"
                                context="{'search_default_main': False, 'search_default_main_cash_filter': active_id}">
                            <field name="sub_cash_count" widget="statinfo" string="Sous-Caisses"/>
                        </button>
                    </div>
                    
                    <!-- En-t√™te -->
                    <div class="oe_title mb-2">
                        <h1>
                            <field name="name" placeholder="Nom de la caisse" required="1" class="text-primary"/>
                        </h1>
                    </div>
                    
                    <!-- Section Informations & Ouverture -->
                    <div class="row">
                        <div class="col-lg-6">
                            <group string="üìã Informations">
                                <field name="code" string="üîñ Code"/>
                                <field name="sequence_id" string="S√©quence" options="{'no_create': True, 'no_create_edit': True}"/>
                                <field name="is_main" string="üè¶ Caisse Principale"/>
                                <field name="main_cash_id" string="Caisse Parente" 
                                       attrs="{'required': [('is_main', '=', False)], 'invisible': [('is_main', '=', True)]}"
                                       options="{'no_create': True}"/>
                                <field name="user_id" string="üë§ Responsable"/>
                                <field name="company_id" groups="base.group_multi_company"/>
                            </group>
                        </div>
                        <div class="col-lg-6">
                            <group string="üìÖ Ouverture/Fermeture">
                                <field name="opening_date" string="üìÖ Date Ouverture" readonly="1"/>
                                <field name="opening_user_id" string="üë§ Ouvert par" readonly="1"/>
                                <field name="opening_balance" string="üíµ Solde Ouverture" widget="monetary"/>
                                <field name="closing_date" string="üìÖ Date Fermeture" readonly="1"/>
                                <field name="closing_user_id" string="üë§ Ferm√© par" readonly="1"/>
                                <field name="closing_balance" string="üíµ Solde Fermeture" widget="monetary" readonly="1"/>
                            </group>
                        </div>
                    </div>
                    
                    <!-- Solde actuel -->
                    <div class="row">
                        <div class="col-12">
                            <div class="alert alert-primary text-center py-3">
                                <h4 class="mb-0">üí∞ Solde Actuel</h4>
                                <h2 class="mb-0 text-primary fw-bold">
                                    <field name="balance" widget="monetary" nolabel="1"/>
                                </h2>
                            </div>
                        </div>
                    </div>
                    
                    <separator string="üìä SOUS-CAISSES" class="mt-4" attrs="{'invisible': [('is_main', '=', False)]}"/>
                    
                    <!-- Sous-caisses -->
                    <field name="sub_cash_ids" nolabel="1" attrs="{'invisible': [('is_main', '=', False)]}">
                        <tree string="Sous-Caisses" create="1" delete="1" 
                              decoration-success="state == 'opened'" decoration-muted="state == 'closed'">
                            <field name="name" string="üè¶ Nom"/>
                            <field name="code" string="üîñ Code"/>
                            <field name="user_id" string="üë§ Responsable"/>
                            <field name="state" string="√âtat" widget="badge"/>
                            <field name="opening_balance" string="üíµ Ouverture" widget="monetary"/>
                            <field name="total_receipts" string="üì• Recettes" sum="Total" widget="monetary"/>
                            <field name="total_expenses" string="üì§ D√©penses" sum="Total" widget="monetary"/>
                            <field name="balance" string="üí∞ Solde" sum="Total" widget="monetary"/>
                        </tree>
                    </field>
                    
                    <separator string="üìã OP√âRATIONS" class="mt-4"/>
                    
                    <!-- Op√©rations -->
                    <field name="operation_ids" nolabel="1">
                        <tree string="Op√©rations" 
                              decoration-success="type == 'receipt' and state == 'confirmed'" 
                              decoration-danger="type == 'expense' and state == 'confirmed'"
                              decoration-muted="state == 'cancelled'">
                            <field name="name" string="üìã R√©f"/>
                            <field name="date" string="üìÖ Date"/>
                            <field name="type" string="Type" widget="badge"/>
                            <field name="amount" string="üíµ Montant" sum="Total" widget="monetary"/>
                            <field name="payment_method" string="üí≥ Mode"/>
                            <field name="invoice_number" string="üìÑ N¬∞ Facture" optional="show"/>
                            <field name="quote_number" string="üìã N¬∞ Devis" optional="show"/>
                            <field name="user_id" string="üë§ Utilisateur"/>
                            <field name="state" string="√âtat" widget="badge"/>
                        </tree>
                    </field>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Vue Recherche des Caisses -->
    <record id="view_cash_register_search" model="ir.ui.view">
        <field name="name">cash.register.search</field>
        <field name="model">cash.register</field>
        <field name="arch" type="xml">
            <search string="Recherche de Caisse">
                <field name="name"/>
                <field name="code"/>
                <field name="user_id"/>
                <separator/>
                <filter string="üü¢ Ouvertes" name="opened" domain="[('state', '=', 'opened')]"/>
                <filter string="üî¥ Ferm√©es" name="closed" domain="[('state', '=', 'closed')]"/>
                <separator/>
                <filter string="üè¶ Caisses Principales" name="main" domain="[('is_main', '=', True)]"/>
                <filter string="üìä Sous-Caisses" name="sub" domain="[('is_main', '=', False)]"/>
                <separator/>
                <filter string="üë§ Mes Caisses" name="my_cashes" domain="[('user_id', '=', uid)]"/>
                <separator/>
                <group expand="0" string="Grouper Par">
                    <filter string="√âtat" name="group_state" context="{'group_by': 'state'}"/>
                    <filter string="Responsable" name="group_user" context="{'group_by': 'user_id'}"/>
                    <filter string="Type" name="group_main" context="{'group_by': 'is_main'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Mise √† jour de l'action pour ajouter la vue de recherche -->
    <record id="action_cash_register" model="ir.actions.act_window">
        <field name="search_view_id" ref="view_cash_register_search"/>
    </record>

    <!-- Vue Liste des Op√©rations -->
    <record id="view_cash_register_operation_tree" model="ir.ui.view">
        <field name="name">cash.register.operation.tree</field>
        <field name="model">cash.register.operation</field>
        <field name="arch" type="xml">
            <tree string="Op√©rations" 
                  decoration-success="type == 'receipt' and state == 'confirmed'" 
                  decoration-danger="type == 'expense' and state == 'confirmed'" 
                  decoration-muted="state == 'cancelled'">
                <field name="name" string="üìã R√©f"/>
                <field name="date" string="üìÖ Date"/>
                <field name="cash_register_id" string="üè¶ Caisse"/>
                <field name="reservation_id" string="‚úàÔ∏è R√©servation" optional="show"/>
                <field name="type" string="Type" widget="badge"/>
                <field name="amount" string="üíµ Montant" sum="Total" widget="monetary" decoration-bf="True"/>
                <field name="payment_method" string="üí≥ Mode"/>
                <field name="invoice_number" string="üìÑ N¬∞ Facture" optional="show"/>
                <field name="invoice_id" string="Facture" optional="hide"/>
                <field name="sale_order_id" string="Devis" optional="hide"/>
                <field name="user_id" string="üë§ Utilisateur"/>
                <field name="state" string="√âtat" widget="badge"/>
            </tree>
        </field>
    </record>

    <!-- Vue Kanban des Op√©rations -->
    <record id="view_cash_register_operation_kanban" model="ir.ui.view">
        <field name="name">cash.register.operation.kanban</field>
        <field name="model">cash.register.operation</field>
        <field name="arch" type="xml">
            <kanban default_group_by="type">
                <field name="name"/>
                <field name="date"/>
                <field name="type"/>
                <field name="amount"/>
                <field name="state"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click o_kanban_record_has_image_fill">
                            <div class="oe_kanban_details p-3">
                                <strong class="o_kanban_record_title text-primary">
                                    <t t-if="record.type.raw_value == 'receipt'">üì•</t>
                                    <t t-else="">üì§</t>
                                    <field name="name"/>
                                </strong>
                                <div class="text-muted mt-1">
                                    üìÖ <field name="date"/>
                                </div>
                                <div class="mt-3">
                                    <span t-attf-class="badge fs-6 #{record.type.raw_value == 'receipt' ? 'bg-success' : 'bg-danger'}">
                                        üí∞ <field name="amount" widget="monetary"/>
                                    </span>
                                </div>
                                <div class="mt-2">
                                    <field name="state" widget="badge"/>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Vue Formulaire des Op√©rations -->
    <record id="view_cash_register_operation_form" model="ir.ui.view">
        <field name="name">cash.register.operation.form</field>
        <field name="model">cash.register.operation</field>
        <field name="arch" type="xml">
            <form string="Op√©ration de Caisse">
                <header>
                    <button name="action_confirm" string="‚úÖ Confirmer" type="object" 
                            class="btn-success" attrs="{'invisible': [('state', '!=', 'draft')]}"/>
                    <button name="action_print_receipt" string="üñ®Ô∏è Imprimer Re√ßu" type="object" 
                            class="btn-secondary"
                            attrs="{'invisible': ['|', ('state', '!=', 'confirmed'), ('type', '!=', 'receipt')]}"/>
                    <button name="action_cancel" string="‚ùå Annuler" type="object" 
                            attrs="{'invisible': [('state', '=', 'cancelled')]}"/>
                    <button name="action_draft" string="üîÑ Brouillon" type="object" 
                            attrs="{'invisible': [('state', '!=', 'cancelled')]}"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,confirmed"/>
                </header>
                <sheet>
                    <!-- Boutons statistiques -->
                    <div class="oe_button_box" name="button_box" attrs="{'invisible': [('reservation_id', '=', False)]}">
                        <button class="oe_stat_button" type="action" name="%(travel_pro_version1.action_reservation)d" 
                                icon="fa-plane" attrs="{'invisible': [('reservation_id', '=', False)]}"
                                context="{'default_reservation_id': reservation_id}">
                            <div class="o_stat_info">
                                <span class="o_stat_text">‚úàÔ∏è R√©servation</span>
                            </div>
                        </button>
                    </div>
                    
                    <!-- En-t√™te -->
                    <div class="oe_title mb-2">
                        <h1>
                            <field name="name" readonly="1" class="text-primary"/>
                        </h1>
                    </div>
                    
                    <!-- Section Informations & Paiement -->
                    <div class="row">
                        <div class="col-lg-6">
                            <group string="üìã Informations">
                                <field name="cash_register_id" string="üè¶ Caisse" options="{'no_create': True}"/>
                                <field name="date" string="üìÖ Date"/>
                                <field name="user_id" string="üë§ Utilisateur"/>
                            </group>
                        </div>
                        <div class="col-lg-6">
                            <group string="üíµ D√©tails Paiement">
                                <field name="type" string="Type" widget="radio" options="{'horizontal': true}"/>
                                <field name="payment_method" string="üí≥ Mode de Paiement"/>
                            </group>
                            <div class="alert alert-primary text-center py-3">
                                <h4 class="mb-0">üíµ Montant</h4>
                                <h2 class="mb-0 text-primary fw-bold">
                                    <field name="amount" widget="monetary" nolabel="1"
                                           attrs="{'readonly': [('state', '!=', 'draft')]}"/>
                                </h2>
                            </div>
                        </div>
                    </div>
                    
                    <separator string="üîó R√âF√âRENCES LI√âES" class="mt-4"/>
                    
                    <div class="row">
                        <div class="col-lg-6">
                            <group>
                                <field name="reservation_id" string="‚úàÔ∏è R√©servation"
                                       attrs="{'readonly': [('state', '!=', 'draft')]}"
                                       options="{'no_create': True}"/>
                                <field name="invoice_number" string="üìÑ N¬∞ Facture" 
                                       attrs="{'readonly': [('state', '!=', 'draft')]}"/>
                                <field name="quote_number" string="üìã N¬∞ Devis" 
                                       attrs="{'readonly': [('state', '!=', 'draft')]}"/>
                            </group>
                        </div>
                        <div class="col-lg-6">
                            <group>
                                <field name="sale_order_id" string="üõí Commande"
                                       attrs="{'readonly': [('state', '!=', 'draft')]}"
                                       options="{'no_create': True}"/>
                                <field name="invoice_id" string="üìÑ Facture Odoo"
                                       domain="[('move_type', 'in', ['out_invoice', 'out_refund'])]"
                                       attrs="{'readonly': [('state', '!=', 'draft')]}"
                                       options="{'no_create': True}"/>
                            </group>
                        </div>
                    </div>
                    
                    <separator string="üìù NOTE" class="mt-4"/>
                    
                    <group>
                        <field name="note" placeholder="R√©f√©rences ou notes sur cette op√©ration..." 
                               nolabel="1" attrs="{'readonly': [('state', '!=', 'draft')]}"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Vue Recherche des Op√©rations -->
    <record id="view_cash_register_operation_search" model="ir.ui.view">
        <field name="name">cash.register.operation.search</field>
        <field name="model">cash.register.operation</field>
        <field name="arch" type="xml">
            <search string="Recherche d'Op√©ration">
                <field name="name"/>
                <field name="cash_register_id"/>
                <field name="invoice_number"/>
                <field name="quote_number"/>
                <field name="reservation_id"/>
                <separator/>
                <filter string="üì• Recettes" name="receipts" domain="[('type', '=', 'receipt')]"/>
                <filter string="üì§ D√©penses" name="expenses" domain="[('type', '=', 'expense')]"/>
                <separator/>
                <filter string="‚úÖ Confirm√©es" name="confirmed" domain="[('state', '=', 'confirmed')]"/>
                <filter string="üìù Brouillons" name="draft" domain="[('state', '=', 'draft')]"/>
                <filter string="‚ùå Annul√©es" name="cancelled" domain="[('state', '=', 'cancelled')]"/>
                <separator/>
                <filter string="üìÖ Aujourd'hui" name="today" domain="[('date', '=', context_today().strftime('%Y-%m-%d'))]"/>
                <filter string="üìÖ Ce mois" name="this_month" domain="[('date', '>=', context_today().strftime('%Y-%m-01'))]"/>
                <separator/>
                <group expand="0" string="Grouper Par">
                    <filter string="Type" name="group_type" context="{'group_by': 'type'}"/>
                    <filter string="Caisse" name="group_cash" context="{'group_by': 'cash_register_id'}"/>
                    <filter string="Mode Paiement" name="group_payment" context="{'group_by': 'payment_method'}"/>
                    <filter string="Date" name="group_date" context="{'group_by': 'date:day'}"/>
                    <filter string="Mois" name="group_month" context="{'group_by': 'date:month'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Mise √† jour des actions avec les vues de recherche -->
    <record id="action_cash_register_operation" model="ir.actions.act_window">
        <field name="search_view_id" ref="view_cash_register_operation_search"/>
    </record>
</odoo>
