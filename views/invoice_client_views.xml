<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vue liste factures clients -->
    <record id="view_travel_invoice_client_tree" model="ir.ui.view">
        <field name="name">travel.invoice.client.tree</field>
        <field name="model">travel.invoice.client</field>
        <field name="arch" type="xml">
            <tree string="Factures Clients" 
                  decoration-info="state=='draft'" 
                  decoration-success="state=='paid'" 
                  decoration-muted="state=='cancel'"
                  decoration-warning="state=='confirmed'">
                <field name="name" string="N¬∞ Facture"/>
                <field name="date_invoice" string="Date"/>
                <field name="travel_company_id" string="Soci√©t√©"/>
                <field name="member_ids" string="Membres" widget="many2many_tags" optional="hide"/>
                <field name="amount_untaxed" string="H.T" sum="Total HT" widget="monetary"/>
                <field name="discount_amount" string="Remise" sum="Remise" optional="show" widget="monetary"/>
                <field name="amount_tax" string="TVA" sum="Total TVA" widget="monetary"/>
                <field name="amount_total" string="TTC" sum="Total TTC" widget="monetary" decoration-bf="True"/>
                <field name="total_withholding" string="Retenues" sum="Total Retenues" widget="monetary" optional="show"/>
                <field name="net_to_pay" string="Net √† Payer" sum="Net √† Payer" widget="monetary" 
                       decoration-bf="True" decoration-success="True"/>
                <field name="state" string="√âtat" widget="badge"/>
            </tree>
        </field>
    </record>

    <!-- Vue Kanban factures clients -->
    <record id="view_travel_invoice_client_kanban" model="ir.ui.view">
        <field name="name">travel.invoice.client.kanban</field>
        <field name="model">travel.invoice.client</field>
        <field name="arch" type="xml">
            <kanban default_group_by="state">
                <field name="name"/>
                <field name="date_invoice"/>
                <field name="travel_company_id"/>
                <field name="amount_total"/>
                <field name="net_to_pay"/>
                <field name="state"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click o_kanban_record_has_image_fill">
                            <div class="oe_kanban_details p-3">
                                <strong class="o_kanban_record_title text-primary">
                                    üìÑ <field name="name"/>
                                </strong>
                                <div class="text-muted mt-1">
                                    üìÖ <field name="date_invoice"/>
                                </div>
                                <div class="mt-1" t-if="record.travel_company_id.value">
                                    üè¢ <field name="travel_company_id"/>
                                </div>
                                <div class="mt-3">
                                    <span class="badge bg-primary fs-6">
                                        üí∞ <field name="amount_total" widget="monetary"/>
                                    </span>
                                </div>
                                <div class="mt-1">
                                    <span class="badge bg-success fs-6">
                                        ‚úÖ Net: <field name="net_to_pay" widget="monetary"/>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Vue formulaire factures clients -->
    <record id="view_travel_invoice_client_form" model="ir.ui.view">
        <field name="name">travel.invoice.client.form</field>
        <field name="model">travel.invoice.client</field>
        <field name="arch" type="xml">
            <form string="Facture Client">
                <header>
                    <button name="action_confirm" string="Confirmer" type="object" 
                            class="btn-success" states="draft"/>
                    <button name="action_pay_cash" string="Payer Caisse" type="object" 
                            class="btn-warning" states="confirmed"/>
                    <button name="action_set_paid" string="Marquer Pay√©e" type="object" 
                            class="btn-info" states="confirmed"/>
                    <button name="action_print_invoice" string="Imprimer" type="object" 
                            class="btn-secondary" states="confirmed,paid"/>
                    <button name="action_cancel" string="Annuler" type="object" states="draft,confirmed"/>
                    <button name="action_draft" string="Brouillon" type="object" states="cancel"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,confirmed,paid"/>
                </header>
                <sheet>
                    <field name="currency_id" invisible="1"/>
                    <field name="fiscal_stamp" invisible="1"/>
                    <field name="company_client_id" invisible="1"/>
                    <field name="company_vat" invisible="1"/>
                    
                    <!-- Boutons statistiques -->
                    <div class="oe_button_box" name="button_box">
                        <button class="oe_stat_button" type="object" name="action_pay_cash" 
                                icon="fa-money" states="confirmed">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Payer</span>
                                <span class="o_stat_text">Caisse</span>
                            </div>
                        </button>
                        <button class="oe_stat_button" type="object" name="action_print_invoice" 
                                icon="fa-print" states="confirmed,paid">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Imprimer</span>
                            </div>
                        </button>
                    </div>
                    
                    <!-- En-t√™te -->
                    <div class="oe_title mb-2">
                        <h1>
                            <field name="name" readonly="1" class="text-primary"/>
                        </h1>
                    </div>
                    
                    <!-- Section Informations & Membres -->
                    <div class="row">
                        <div class="col-lg-6">
                            <group string="Informations">
                                <field name="date_invoice" string="Date"/>
                                <field name="travel_company_id" string="Soci√©t√©" 
                                       options="{'no_create': True}" required="1"/>
                            </group>
                        </div>
                        <div class="col-lg-6">
                            <group string="Membres">
                                <field name="member_ids" widget="many2many_tags" nolabel="1"
                                       domain="[('company_id', '=', travel_company_id)]"
                                       options="{'no_create': True}"
                                       attrs="{'required': [('travel_company_id', '!=', False)]}"/>
                            </group>
                        </div>
                    </div>
                    
                    <separator string="Lignes de Facturation" class="mt-4"/>
                    
                    <!-- Lignes de facturation -->
                    <field name="invoice_line_ids" mode="tree,kanban">
                        <tree string="Lignes" editable="bottom">
                            <field name="sequence" widget="handle"/>
                            <field name="passenger_id" string="Passager" options="{'no_create': True}" 
                                   domain="[('company_id', '=', parent.travel_company_id)]"/>
                            <field name="destination_id" string="Voyage" options="{'no_create': True}"/>
                            <field name="reference" string="R√©f√©rence"/>
                            <field name="description" string="Description"/>
                            <field name="reservation_id" string="R√©servation" optional="hide"/>
                            <field name="price_ttc" string="Prix TTC" widget="monetary" sum="Total"/>
                            <field name="credit_info" string="Cr√©dit" optional="show"
                                   readonly="1" decoration-bf="credit_info"
                                   style="color: #28a745; font-weight: bold;"/>
                            <field name="tax_rate" invisible="1"/>
                            <field name="currency_id" invisible="1"/>
                        </tree>
                    </field>
                    
                    <separator string="Calcul des Montants" class="mt-4"/>
                    
                    <!-- Section calcul -->
                    <div class="row">
                        <div class="col-lg-6">
                            <group string="Remise">
                                <field name="discount_type" string="Type"/>
                                <field name="discount_rate" string="Taux (%)"
                                       attrs="{'invisible': [('discount_type', '!=', 'percent')]}"/>
                                <field name="discount_fixed" string="Montant Fixe" widget="monetary"
                                       attrs="{'invisible': [('discount_type', '!=', 'fixed')]}"/>
                            </group>
                        </div>
                        <div class="col-lg-6">
                            <group string="üìä Totaux">
                                <field name="amount_untaxed" string="Total H.T" widget="monetary" readonly="1"/>
                                <field name="discount_amount" string="Remise" widget="monetary" readonly="1"
                                       attrs="{'invisible': [('discount_type', '=', 'none')]}"/>
                                <field name="amount_after_discount" string="H.T apr√®s remise" widget="monetary" readonly="1"
                                       attrs="{'invisible': [('discount_type', '=', 'none')]}"/>
                                <field name="amount_tax" string="T.V.A 7%" widget="monetary" readonly="1"/>
                                <div class="alert alert-primary text-center py-2 mt-2">
                                    <span class="text-muted">Total TTC</span>
                                    <h3 class="mb-0 text-primary fw-bold">
                                        <field name="amount_total" widget="monetary" nolabel="1"/>
                                    </h3>
                                </div>
                            </group>
                        </div>
                    </div>
                    
                    <separator string="üìâ RETENUES √Ä LA SOURCE" class="mt-4"/>
                    
                    <div class="row">
                        <div class="col-lg-6">
                            <group string="Retenue 1% sur TTC">
                                <field name="apply_withholding_tax" string="Appliquer"/>
                                <field name="withholding_tax_amount" string="Montant" widget="monetary" readonly="1"
                                       attrs="{'invisible': [('apply_withholding_tax', '=', False)]}"/>
                            </group>
                        </div>
                        <div class="col-lg-6">
                            <group string="Retenue 25% sur TVA">
                                <field name="apply_vat_withholding" string="Appliquer"/>
                                <field name="vat_withholding_amount" string="Montant" widget="monetary" readonly="1"
                                       attrs="{'invisible': [('apply_vat_withholding', '=', False)]}"/>
                            </group>
                        </div>
                    </div>
                    
                    <!-- Net √† payer -->
                    <div class="row" attrs="{'invisible': [('total_withholding', '=', 0)]}">
                        <div class="col-12">
                            <group>
                                <field name="total_withholding" string="üìâ Total Retenues" widget="monetary" readonly="1"/>
                            </group>
                            <div class="alert alert-success text-center py-3">
                                <span class="text-muted">Net √† Payer</span>
                                <h2 class="mb-0 text-success fw-bold">
                                    <field name="net_to_pay" widget="monetary" nolabel="1"/>
                                </h2>
                            </div>
                        </div>
                    </div>
                    
                    <group>
                        <field name="amount_in_words_fr" string="üí¨ Montant en lettres" readonly="1"/>
                    </group>
                    
                    <separator string="Notes" class="mt-4"/>
                    
                    <group>
                        <field name="note" placeholder="Notes internes..." nolabel="1"/>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Vue recherche -->
    <record id="view_travel_invoice_client_search" model="ir.ui.view">
        <field name="name">travel.invoice.client.search</field>
        <field name="model">travel.invoice.client</field>
        <field name="arch" type="xml">
            <search string="Rechercher Factures">
                <field name="name" string="Num√©ro"/>
                <field name="travel_company_id" string="Soci√©t√©"/>
                <field name="member_ids" string="Membres"/>
                <field name="date_invoice" string="Date"/>
                <separator/>
                <filter string="Brouillon" name="draft" domain="[('state', '=', 'draft')]"/>
                <filter string="Confirm√©es" name="confirmed" domain="[('state', '=', 'confirmed')]"/>
                <filter string="üíµ Pay√©es" name="paid" domain="[('state', '=', 'paid')]"/>
                <filter string="‚ùå Annul√©es" name="cancel" domain="[('state', '=', 'cancel')]"/>
                <separator/>
                <filter string="üìâ Avec Retenues" name="with_withholdings" 
                        domain="['|', ('apply_withholding_tax', '=', True), ('apply_vat_withholding', '=', True)]"/>
                <separator/>
                <group expand="0" string="Grouper Par">
                    <filter string="Soci√©t√©" name="group_company" context="{'group_by': 'travel_company_id'}"/>
                    <filter string="Date" name="group_date" context="{'group_by': 'date_invoice:month'}"/>
                    <filter string="√âtat" name="group_state" context="{'group_by': 'state'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Action -->
    <record id="action_travel_invoice_client" model="ir.actions.act_window">
        <field name="name">Factures Clients</field>
        <field name="res_model">travel.invoice.client</field>
        <field name="view_mode">tree,kanban,form</field>
        <field name="context">{'search_default_confirmed': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Cr√©er une nouvelle facture client
            </p>
            <p>
                S√©lectionnez une soci√©t√© cliente et ajoutez les lignes de facturation pour chaque passager.
            </p>
        </field>
    </record>
</odoo>
